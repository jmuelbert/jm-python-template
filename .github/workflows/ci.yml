---
# SPDX-License-Identifier: EUPL-1.2
# SPDX-FileCopyrightText: 2025-present Jürgen Mülbert <juergen.muelbert@outlook.de>

name: Core CI
run-name: "${{ github.event_name == 'workflow_dispatch' && format('CI: {0}', github.ref_name) || '' }}"
# yamllint disable-line rule:truthy
on:
  push:
    branches: [main, develop]
    paths:
      - src/**
      - pyproject.toml
      - .github/workflows/ci.yml
      - .github/actions/**
  pull_request:
    types: [opened, synchronize, reopened]

env:
  FORCE_COLOR: "1"
  PACKAGE_NAME: jm-python-template

defaults:
  run:
    shell: bash
permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-and-format:
    name: Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: 🔒 Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
      - name: 🧐 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Install Node dependencies
        run: pnpm install
      - name: ✨ Run Node linters & formatting
        run: |
          pnpm run lint:prettier
          pnpm run lint:docs
      - name: Setup Python environment
        uses: ./.github/actions/python-setup
      - name: ⚙️ Install Python dev env
        run: hatch env create lint
      - name: 🔍 Run Python linters & checks
        run: hatch run dev:lint
      - name: 🔍 Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          severity: CRITICAL,HIGH

  test:
    name: Test with ${{ matrix.os }}
    needs: lint-and-format
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: 🔒 Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
      - name: 🧰 Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Python
        uses: ./.github/actions/python-setup
        id: python-setup
      - name: ⚙️ Install Python dev env
        run: hatch env create test
      - name: 🧪 Run tests
        run: |
          hatch run test:cov

      - name: 📢 Push Coverage Badge JSON
        run: bash .github/scripts/update-coverage-badge
