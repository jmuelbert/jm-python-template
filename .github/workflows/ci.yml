---
# SPDX-License-Identifier: EUPL-1.2
# SPDX-FileCopyrightText: 2025-present Jürgen Mülbert <juergen.muelbert@outlook.de>

name: Core CI
run-name: "${{ github.event_name == 'workflow_dispatch' && format('CI: {0}', github.ref_name) || '' }}"
# yamllint disable-line rule:truthy
on:
  push:
    branches: [main, develop]
    paths:
      - src/**
      - pyproject.toml
      - .github/workflows/ci.yml
      - .github/actions/**
  pull_request:
    types: [opened, synchronize, reopened]

env:
  FORCE_COLOR: "1"
  PACKAGE_NAME: jm-python-template

defaults:
  run:
    shell: bash
permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-and-format:
    name: Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: 🔒 Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
      - name: 🧐 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Python
        uses: ./.github/actions/python-setup
        id: python-setup

      # Lint the Codebase
      - name: Run lint Codebase ▶️
        run: hatch run dev:lint

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Install tools
        run: pnpm install

      # Lint toml.
      - name: Lint configs.
        run: pnpm run lint:toml

      # Lint prettier.
      - name: Lint prettier.
        run: pnpm run lint:prettier

      - name: 🔍 Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          severity: CRITICAL,HIGH

  tests:
    name: Test with ${{ matrix.os }}
    needs: lint-and-format
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: 🔒 Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
      - name: 🧰 Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Python
        uses: ./.github/actions/python-setup
        id: python-setup
      - name: 🧪📊 Run tests and coverage
        run: |
          hatch test --cover -all

      - name: Upload coverage data
        uses: actions/upload-artifact@v4
        with:
          name: coverage-data-${{ matrix.os }}
          path: .coverage

  combine-and-badge:
    runs-on: ubuntu-latest
    needs: tests
    if: github.ref == 'refs/heads/main'

    steps:
      - name: 🔒 Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
      - name: 🧰 Checkout Repository
        uses: actions/checkout@v4

      - name: Download all coverage data artifacts
        uses: actions/download-artifact@v4
        with:
          path: .

      - name: Setup Python
        uses: ./.github/actions/python-setup
        id: python-setup

      - name: Combine coverage data
        run: |
          pip install coverage
          python -m coverage combine

      - name: Generate final coverage.xml
        run: python -m coverage xml

      - name: 📢 Push Coverage Badge JSON
        run: bash .github/scripts/update-coverage-badge

      - name: Git Auto Commit
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: update coverage badge"
          file_pattern: .github/badges/coverage.json
